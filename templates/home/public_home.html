{% extends 'base.html' %}
{% block title %}Public Transparency Hub{% endblock %}

{% block hero %}
<section class="hero-portal py-5 position-relative overflow-hidden">
  <div class="container position-relative">
    <div class="row align-items-center g-4">
      <div class="col-lg-7">
        <div class="d-inline-flex align-items-center gap-2 px-3 py-2 rounded-pill bg-white bg-opacity-10 text-white small fw-semibold shadow-sm mb-3">
          <i class="bi bi-globe2"></i>
          <span>Citizen-facing transparency</span>
        </div>
        <h1 class="display-6 fw-semibold text-white mb-2">Every public record, visible to every citizen.</h1>
        <p class="lead text-white-50">Projects, complaints, RTI events, and dashboards stay open, while private and sensitive data remain protected.</p>
        <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
          <span class="badge bg-light text-primary"><i class="bi bi-binoculars me-1"></i>Read-only search</span>
          <span class="badge bg-primary-subtle text-dark text-opacity-75"><i class="bi bi-shield-check me-1"></i>Permission re-check on every click</span>
          <span class="badge bg-white text-primary"><i class="bi bi-people me-1"></i>Built for citizens</span>
        </div>
        <div class="card shadow-lg border-0 glass-card search-card">
          <div class="card-body p-3 p-md-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div>
                <div class="text-uppercase small text-muted mb-1">Open search</div>
                <div class="fw-semibold text-dark">Find public records fast</div>
              </div>
              <span class="badge bg-success-subtle text-success"><i class="bi bi-shield-lock me-1"></i>Safe</span>
            </div>
            <form class="row g-2" method="get" action="{{ url_for('main.index') }}">
              <div class="col-md-5">
                <div class="input-group input-group-lg rounded-3 overflow-hidden shadow-sm">
                  <span class="input-group-text bg-white border-0 text-muted"><i class="bi bi-geo-alt"></i></span>
                  <input type="text" name="city" value="{{ filters.city }}" class="form-control border-0" placeholder="Search by city or area" aria-label="Search by city or area">
                </div>
              </div>
              <div class="col-md-5">
                <div class="input-group input-group-lg rounded-3 overflow-hidden shadow-sm">
                  <span class="input-group-text bg-white border-0 text-muted"><i class="bi bi-diagram-3"></i></span>
                  <input type="text" name="project_type" value="{{ filters.project_type }}" class="form-control border-0" placeholder="Project type (Road, Bridge, Water)" aria-label="Project type">
                </div>
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-primary btn-lg btn-loading" type="submit">
                  <span class="d-inline-flex align-items-center justify-content-center gap-2"><i class="bi bi-search"></i><span>Search</span></span>
                </button>
              </div>
            </form>
            <div class="small text-muted mt-2">Search is read-only. Results are filtered through explicit is_public and visibility_level checks.</div>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="card shadow-lg border-0 transparency-card glass-card h-100">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <p class="text-uppercase small text-muted mb-1">Live Transparency Snapshot</p>
                <h5 class="mb-0 fw-semibold text-primary">Public view</h5>
              </div>
              <span class="badge bg-success-subtle text-success"><i class="bi bi-unlock me-1"></i>Public</span>
            </div>
            <div class="row g-3">
              <div class="col-6">
                <div class="stat-chip">
                  <div class="d-flex align-items-center justify-content-between mb-1">
                    <span class="icon-circle icon-circle-soft text-primary"><i class="bi bi-kanban"></i></span>
                    <span class="badge bg-primary-subtle text-primary">Live</span>
                  </div>
                  <div class="small text-muted">Projects surfaced</div>
                  <div class="fs-4 fw-semibold text-primary">{{ projects|length }}</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-chip">
                  <div class="d-flex align-items-center justify-content-between mb-1">
                    <span class="icon-circle icon-circle-soft text-danger"><i class="bi bi-megaphone"></i></span>
                    <span class="badge bg-danger-subtle text-danger">Safe</span>
                  </div>
                  <div class="small text-muted">Complaints shown</div>
                  <div class="fs-4 fw-semibold text-primary">{{ complaints|length }}</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-chip">
                  <div class="d-flex align-items-center justify-content-between mb-1">
                    <span class="icon-circle icon-circle-soft text-warning"><i class="bi bi-activity"></i></span>
                    <span class="badge bg-warning-subtle text-warning">Stream</span>
                  </div>
                  <div class="small text-muted">Activity items</div>
                  <div class="fs-4 fw-semibold text-primary">{{ activity_feed|length }}</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-chip">
                  <div class="d-flex align-items-center justify-content-between mb-1">
                    <span class="icon-circle icon-circle-soft text-success"><i class="bi bi-stopwatch"></i></span>
                    <span class="badge bg-success-subtle text-success">Cache</span>
                  </div>
                  <div class="small text-muted">Cache window (sec)</div>
                  <div class="fs-4 fw-semibold text-primary">{{ cache_window }}</div>
                </div>
              </div>
            </div>
            <div class="alert alert-info mt-3 mb-0 small d-flex align-items-start gap-2">
              <i class="bi bi-shield-check mt-1"></i>
              <span>Personal identifiers, emails, and phone numbers never appear here. All links re-check permissions at access time.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="public-hub">
  <div class="section-header d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <span class="icon-circle icon-circle-light bg-primary-subtle text-primary"><i class="bi bi-compass"></i></span>
      <div>
        <p class="text-uppercase small text-muted mb-1">Public Project Discovery</p>
        <h2 class="h4 mb-0">Recently discovered projects from every citizen</h2>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span class="small text-muted d-none d-md-inline">Publicly viewable records</span>
      <a class="btn btn-outline-primary btn-sm btn-hover-lift" href="{{ url_for('projects.public_projects') }}"><i class="bi bi-box-arrow-up-right me-1"></i>View all projects</a>
    </div>
  </div>

  <div class="card border-0 shadow-sm glass-card mb-4">
    <div class="card-body p-3 p-md-4">
      {% if project_groups %}
        {% for area, items in project_groups.items() %}
        <div class="mb-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold text-primary d-flex align-items-center gap-2"><i class="bi bi-geo-alt"></i><span>{{ area }}</span></div>
            <a class="small d-flex align-items-center gap-1 text-primary" href="{{ url_for('projects.public_projects', city=area) }}"><i class="bi bi-funnel"></i><span>Filter by this area</span></a>
          </div>
          <div class="row g-3">
            {% for project in items %}
            <div class="col-md-6 col-lg-4">
              <div class="card border-0 h-100 glass-card lift-card">
                <div class="card-body d-flex flex-column">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex flex-column gap-1">
                      <div class="d-inline-flex align-items-center gap-1 small text-muted">
                        <i class="bi bi-diagram-3 text-primary"></i>
                        <span>{{ project.type }}</span>
                      </div>
                      <h3 class="h6 fw-semibold text-primary mb-0">{{ project.name }}</h3>
                      <div class="small text-muted"><i class="bi bi-geo-alt me-1"></i>{{ project.area or 'Location pending' }}</div>
                    </div>
                    {% set badge = status_badges.get(project.status, 'secondary') %}
                    <span class="badge bg-{{ badge }} text-white">{{ project.status }}</span>
                  </div>
                  <div class="d-flex flex-wrap gap-2 small text-muted mt-2">
                    <span class="tag-pill"><i class="bi bi-building-gear me-1"></i>Department: {{ project.department or 'Not recorded' }}</span>
                    <span class="tag-pill"><i class="bi bi-unlock me-1"></i>Public</span>
                  </div>
                  <div class="mt-auto d-flex justify-content-between align-items-center pt-3">
                    <span class="badge bg-primary-subtle text-primary d-inline-flex align-items-center gap-1"><i class="bi bi-globe2"></i><span>Open</span></span>
                    <a class="btn btn-sm btn-primary btn-hover-lift" href="{{ url_for('projects.public_project_detail', project_id=project.id) }}"><i class="bi bi-box-arrow-up-right me-1"></i>View details</a>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-secondary mb-0">No public projects available yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="section-header d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <span class="icon-circle icon-circle-light bg-info-subtle text-info"><i class="bi bi-shield-exclamation"></i></span>
      <div>
        <p class="text-uppercase small text-muted mb-1">Public Complaint Visibility</p>
        <h2 class="h4 mb-0">Recent complaints (anonymized)</h2>
      </div>
    </div>
    <a class="btn btn-outline-primary btn-sm btn-hover-lift" href="{{ url_for('complaints.public_complaints') }}"><i class="bi bi-arrow-right"></i>View all complaints</a>
  </div>
  <div class="card border-0 shadow-sm glass-card mb-4">
    <div class="card-body p-3 p-md-4">
      <div class="row g-3">
        {% for complaint in complaints %}
        <div class="col-md-6 col-lg-4">
          <div class="card border-0 h-100 glass-card lift-card">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="small text-muted d-flex align-items-center gap-1"><i class="bi bi-kanban"></i><span>Project</span></div>
                <span class="badge bg-light text-white">{{ complaint.status }}</span>
              </div>
              <h3 class="h6 fw-semibold text-primary mb-2">{{ complaint.project_name or 'Project not specified' }}</h3>
              <div class="d-flex flex-wrap gap-2 mb-2">
                <span class="badge bg-light text-white">{{ complaint.issue_type }}</span>
                <span class="badge bg-{{ complaint_severity_badges.get(complaint.severity, 'secondary') }} text-white">{{ complaint.severity }}</span>
                <span class="badge bg-{{ complaint_status_badges.get(complaint.status, 'secondary') }} text-white">{{ complaint.status }}</span>
              </div>
              <div class="small text-muted">Area: {{ complaint.area or 'Area not shared' }}</div>
              <div class="small text-muted">Filed: {{ complaint.created_at.strftime('%Y-%m-%d %H:%M') if complaint.created_at else 'N/A' }}</div>
              <div class="mt-auto d-flex justify-content-between align-items-center pt-3">
                <span class="badge bg-primary-subtle text-primary d-inline-flex align-items-center gap-1"><i class="bi bi-person-fill-slash"></i><span>Anonymized</span></span>
                <a class="btn btn-sm btn-outline-primary btn-hover-lift" href="{{ url_for('complaints.public_complaint_detail', complaint_id=complaint.id) }}">Read status</a>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="col-12">
          <div class="alert alert-secondary mb-0">No public complaints available yet.</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="section-header d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <span class="icon-circle icon-circle-light bg-warning-subtle text-warning"><i class="bi bi-broadcast"></i></span>
      <div>
        <p class="text-uppercase small text-muted mb-1">System Activity Feed</p>
        <h2 class="h4 mb-0">Public events across the platform</h2>
      </div>
    </div>
  </div>
  <div class="card shadow-sm border-0 mb-4 glass-card">
    <div class="card-body">
      <div class="timeline">
        {% for item in activity_feed %}
        <div class="timeline-item">
          <div class="timeline-icon bg-primary"></div>
          <div class="timeline-content">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div class="fw-semibold text-primary text-capitalize d-flex align-items-center gap-1"><i class="bi bi-lightning-charge"></i><span>{{ item.kind.replace('_', ' ') }}</span></div>
              <span class="badge bg-light text-white">{{ item.status }}</span>
            </div>
            <div class="small text-muted">{{ item.title }}</div>
            {% if item.area %}<div class="small text-muted">Area: {{ item.area }}</div>{% endif %}
            <div class="small text-muted">{{ item.timestamp.strftime('%Y-%m-%d %H:%M') if item.timestamp else 'Timestamp pending' }}</div>
          </div>
        </div>
        {% else %}
        <div class="text-muted small">No public activity yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="section-header d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <span class="icon-circle icon-circle-light bg-secondary-subtle text-secondary"><i class="bi bi-rocket-takeoff"></i></span>
      <div>
        <p class="text-uppercase small text-muted mb-1">Quick Access</p>
        <h2 class="h4 mb-0">One-click public destinations</h2>
      </div>
    </div>
  </div>
  <div class="row g-3">
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0 h-100 quick-link-card glass-card">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2"><i class="bi bi-building me-2 text-primary"></i><span class="fw-semibold">All Projects</span></div>
          <p class="small text-muted mb-3">Browse every public project record without login.</p>
          <a class="btn btn-sm btn-primary mt-auto btn-hover-lift" href="{{ url_for('projects.public_projects') }}">Open</a>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0 h-100 quick-link-card glass-card">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2"><i class="bi bi-megaphone me-2 text-primary"></i><span class="fw-semibold">All Complaints</span></div>
          <p class="small text-muted mb-3">See anonymized complaints, issue types, and statuses.</p>
          <a class="btn btn-sm btn-primary mt-auto btn-hover-lift" href="{{ url_for('complaints.public_complaints') }}">Open</a>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0 h-100 quick-link-card glass-card">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2"><i class="bi bi-graph-up me-2 text-primary"></i><span class="fw-semibold">Dashboards</span></div>
          <p class="small text-muted mb-3">Public transparency dashboards for trends and patterns.</p>
          <a class="btn btn-sm btn-primary mt-auto btn-hover-lift" href="{{ url_for('transparency.public_dashboard') }}">Open</a>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0 h-100 quick-link-card glass-card">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2"><i class="bi bi-search me-2 text-primary"></i><span class="fw-semibold">Search Projects</span></div>
          <p class="small text-muted mb-3">Filter by city or type, even when not logged in.</p>
          <a class="btn btn-sm btn-primary mt-auto btn-hover-lift" href="{{ url_for('projects.public_projects') }}">Search</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
