{% extends 'base.html' %}
{% block title %}Complaint Detail{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-12">
    <div class="card page-hero-card lift-card border-0 shadow-lg overflow-hidden">
      <div class="card-body p-4 p-lg-5 position-relative">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
          <div class="d-flex flex-column gap-2">
            <div class="d-inline-flex align-items-center gap-2 text-uppercase small fw-semibold text-white-50">
              <i class="bi bi-bullseye"></i><span>Citizen Complaint</span>
            </div>
            <h1 class="h4 text-white mb-0">{{ complaint.title }}</h1>
            <div class="d-flex flex-wrap align-items-center gap-2">
              <span class="badge rounded-pill bg-{{ complaint.severity_level | severity_badge }} text-white d-inline-flex align-items-center gap-1"><i class="bi bi-flag"></i>{{ complaint.severity_level }}</span>
              <span class="badge rounded-pill bg-{{ complaint.status | status_badge }} text-white d-inline-flex align-items-center gap-1"><i class="bi bi-check2-circle"></i>{{ complaint.status }}</span>
              <span class="badge rounded-pill bg-{{ complaint.images[0].authenticity_flag | auth_badge if complaint.images|length>0 else 'secondary' }} text-white d-inline-flex align-items-center gap-1"><i class="bi bi-shield-check"></i>{{ complaint.images[0].authenticity_flag if complaint.images|length>0 else 'UNVERIFIABLE' }}</span>
              {% if complaint.is_offline_submission %}<span class="badge rounded-pill bg-dark d-inline-flex align-items-center gap-1"><i class="bi bi-cloud-off"></i>Offline</span>{% endif %}
              {% if complaint.sync_status %}<span class="badge rounded-pill bg-secondary d-inline-flex align-items-center gap-1"><i class="bi bi-arrow-repeat"></i>{{ complaint.sync_status }}</span>{% endif %}
            </div>
            <div class="d-flex flex-wrap align-items-center gap-3 meta-chip-row mt-2">
              <div class="meta-chip">
                <i class="bi bi-hash"></i>
                <div>
                  <div class="small text-white-50">Complaint ID</div>
                  <div class="fw-semibold text-white">{{ complaint.id }}</div>
                </div>
              </div>
              <div class="meta-chip">
                <i class="bi bi-clock-history"></i>
                <div>
                  <div class="small text-white-50">Filed on</div>
                  <div class="fw-semibold text-white">{{ complaint.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
              </div>
              <div class="meta-chip">
                <i class="bi bi-building"></i>
                <div>
                  <div class="small text-white-50">Project</div>
                  <div class="fw-semibold text-white">{{ complaint.project.project_name }} ({{ complaint.project.project_type }})</div>
                </div>
              </div>
            </div>
          </div>
          <div class="text-end d-flex flex-column align-items-end gap-2">
            <a class="btn btn-outline-primary btn-hover-lift btn-sm d-inline-flex align-items-center gap-2" href="{{ url_for('transparency.rti_complaint', complaint_id=complaint.id) }}">
              <i class="bi bi-file-earmark-lock"></i>
              <span>RTI Mode</span>
            </a>
            <div class="small text-white-50">Generates legal PDF with checksum.</div>
          </div>
        </div>
        <div class="gradient-overlay"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card glass-card border-0 shadow-sm lift-card mb-3">
      <div class="card-body">
        <div class="section-heading">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-primary-subtle text-primary"><i class="bi bi-journal-text"></i></span>
            <div>
              <h6 class="mb-0">Summary</h6>
              <small class="text-muted">Key context for reviewers</small>
            </div>
          </div>
        </div>
        <p class="mb-2 lead-text">{{ complaint.description }}</p>
        {% if complaint.location_snapshot %}
        <div class="d-flex flex-wrap gap-3 text-muted small">
          <span class="d-inline-flex align-items-center gap-1"><i class="bi bi-geo-alt"></i>{{ complaint.location_snapshot.location_name or complaint.location_snapshot.project_name }}</span>
          {% if complaint.location_snapshot.latitude %}
          <span class="d-inline-flex align-items-center gap-1"><i class="bi bi-compass"></i>Lat {{ complaint.location_snapshot.latitude }}, Lng {{ complaint.location_snapshot.longitude }}</span>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card glass-card border-0 shadow-sm lift-card mb-3">
      <div class="card-body">
        <div class="section-heading mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-info-subtle text-info"><i class="bi bi-envelope-check"></i></span>
            <div>
              <h6 class="mb-0">Official Communication &amp; Follow-Ups</h6>
              <small class="text-muted">Automated notices and reminders</small>
            </div>
          </div>
        </div>
        {% set email_status = complaint.last_email_status or 'PENDING' %}
        <div class="row g-3">
          <div class="col-md-6">
            <div class="info-tile d-flex align-items-center gap-3">
              <span class="icon-circle bg-primary-subtle text-primary"><i class="bi bi-send"></i></span>
              <div>
                <div class="text-muted small">Initial email sent</div>
                <div class="fw-semibold">{{ complaint.notification_sent_at.strftime('%Y-%m-%d %H:%M') if complaint.notification_sent_at else 'Pending dispatch' }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-tile d-flex align-items-center gap-3">
              <span class="icon-circle bg-success-subtle text-success"><i class="bi bi-mailbox"></i></span>
              <div>
                <div class="text-muted small">Delivery status</div>
                <span class="badge px-3 py-2 rounded-pill bg-{% if email_status == 'SENT' %}success{% elif email_status == 'RETRY_PENDING' %}warning{% elif email_status == 'FAILED' %}danger{% else %}secondary{% endif %} text-white">{{ email_status }}</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-tile d-flex align-items-center gap-3">
              <span class="icon-circle bg-warning-subtle text-warning"><i class="bi bi-repeat"></i></span>
              <div>
                <div class="text-muted small">Follow-up count</div>
                <div class="fw-semibold">{{ complaint.follow_up_count or 0 }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-tile d-flex align-items-center gap-3">
              <span class="icon-circle bg-secondary-subtle text-secondary"><i class="bi bi-calendar-check"></i></span>
              <div>
                <div class="text-muted small">Last reminder date</div>
                <div class="fw-semibold">{{ complaint.last_follow_up_at.strftime('%Y-%m-%d %H:%M') if complaint.last_follow_up_at else 'Not triggered yet' }}</div>
              </div>
            </div>
          </div>
        </div>
        {% if email_status == 'FAILED' %}
        <div class="alert alert-warning d-flex align-items-start gap-3 mt-3">
          <div>
            <div class="fw-semibold">Email delivery failed</div>
            <div class="small mb-2">{{ last_email_error or 'No error message captured.' }}</div>
            <form method="POST" action="{{ url_for('complaints.resend_complaint_email', complaint_id=complaint.id) }}" class="d-inline-block">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-outline-primary btn-sm btn-hover-lift">Retry send</button>
            </form>
          </div>
        </div>
        {% endif %}
        <div class="mt-3">
          <div class="small text-muted fw-semibold mb-1">Recipients (masked)</div>
          <div class="row g-2 small">
            <div class="col-sm-6">
              <div class="info-line"><i class="bi bi-person-badge"></i><span>Contractor: {{ recipient_snapshot.contractor|mask_email if recipient_snapshot.contractor else 'Not available' }}</span></div>
            </div>
            <div class="col-sm-6">
              <div class="info-line"><i class="bi bi-building"></i><span>Department: {{ recipient_snapshot.department|mask_email if recipient_snapshot.department else 'Not available' }}</span></div>
            </div>
            {% if recipient_snapshot.monitor %}
            <div class="col-sm-6">
              <div class="info-line"><i class="bi bi-shield"></i><span>CC Monitoring: {{ recipient_snapshot.monitor|mask_email }}</span></div>
            </div>
            {% endif %}
            {% if recipient_snapshot.higher %}
            <div class="col-sm-6">
              <div class="info-line"><i class="bi bi-arrow-up-circle"></i><span>CC Escalation: {{ recipient_snapshot.higher|mask_email }}</span></div>
            </div>
            {% endif %}
          </div>
          <div class="alert alert-info small mb-0 mt-3 d-flex align-items-start gap-2"><i class="bi bi-info-circle"></i><span>Emails are auto-dispatched via SMTP with attachments and logged for audit. Citizens cannot edit email content.</span></div>
        </div>
      </div>
    </div>

    <div class="card glass-card border-0 shadow-sm lift-card mb-3">
      <div class="card-body">
        <div class="section-heading mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-success-subtle text-success"><i class="bi bi-cpu"></i></span>
            <div>
              <h6 class="mb-0">AI Findings</h6>
              <small class="text-muted">Automated authenticity review</small>
            </div>
          </div>
        </div>
        {% set analysis = complaint.images[0].ai_analysis_result if complaint.images|length > 0 else {} %}
        <div class="row g-3">
          <div class="col-md-6">
            <div class="info-tile d-flex align-items-center gap-3">
              <span class="icon-circle bg-primary-subtle text-primary"><i class="bi bi-activity"></i></span>
              <div>
                <div class="text-muted small">Issue type</div>
                <div class="fw-semibold">{{ analysis.issue_type or complaint.complaint_type }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-tile d-flex align-items-center gap-3">
              <span class="icon-circle bg-warning-subtle text-warning"><i class="bi bi-shield-check"></i></span>
              <div>
                <div class="text-muted small">Authenticity</div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge rounded-pill bg-{{ analysis.authenticity_flag | auth_badge }} text-white px-3 py-2">{{ analysis.authenticity_flag or 'UNVERIFIABLE' }}</span>
                  <span class="small text-muted">AI-assisted</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="info-tile flex-column">
              <div class="d-flex align-items-center gap-2 mb-2 text-muted small"><i class="bi bi-text-paragraph"></i><span>AI Summary</span></div>
              {% if analysis_markdown_html %}
                <div class="markdown-body small" style="line-height: 1.6;">
                  {{ analysis_markdown_html|safe }}
                </div>
              {% else %}
                <div class="small">{{ analysis.ai_summary or complaint.ai_generated_summary or 'No AI summary captured.' }}</div>
              {% endif %}
            </div>
          </div>
          <div class="col-12">
            <div class="info-tile flex-column">
              <div class="d-flex align-items-center gap-2 mb-2 text-muted small"><i class="bi bi-list-check"></i><span>Authenticity reasons</span></div>
              <ul class="small mb-0 ps-3">
                {% for reason in analysis.authenticity_reasons or [] %}<li>{{ reason }}</li>{% else %}<li>No authenticity notes recorded.</li>{% endfor %}
              </ul>
            </div>
          </div>
        </div>
        <div class="alert alert-secondary mt-3 small mb-0 d-flex align-items-start gap-2"><i class="bi bi-shield-exclamation"></i><span>This authenticity badge is AI-assisted and not final proof. Administrators will perform manual verification.</span></div>
      </div>
    </div>

    <div class="card glass-card border-0 shadow-sm lift-card mb-3">
      <div class="card-body">
        <div class="section-heading mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-secondary-subtle text-secondary"><i class="bi bi-intersect"></i></span>
            <div>
              <h6 class="mb-0">Status Timeline</h6>
              <small class="text-muted">Step-by-step audit trail</small>
            </div>
          </div>
        </div>
        <div class="timeline">
          {% for event in timeline_events %}
          <div class="timeline-item">
            <div class="timeline-icon bg-primary"></div>
            <div class="timeline-content">
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-semibold">{{ event.label }}</div>
                <span class="badge bg-{{ event.badge_class }} text-white">{{ event.badge_label }}</span>
              </div>
              {% if event.detail %}<div class="small text-muted">{{ event.detail }}</div>{% endif %}
              <div class="small text-muted">{{ event.timestamp.strftime('%Y-%m-%d %H:%M') if event.timestamp else '' }}</div>
            </div>
          </div>
          {% else %}
          <div class="text-muted small">No status history yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="card glass-card border-0 shadow-sm lift-card">
      <div class="card-body">
        <div class="section-heading mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-primary-subtle text-primary"><i class="bi bi-people"></i></span>
            <div>
              <h6 class="mb-0">Community Support</h6>
              <small class="text-muted">Public concern and evidence</small>
            </div>
          </div>
        </div>
        <p class="small text-muted mb-3">Nearby verified users can add remarks or supporting photos. Abuse is monitored. Community support indicates public concern, not legal verdict.</p>
        <form method="POST" action="{{ url_for('complaints.support_complaint', complaint_id=complaint.id) }}" enctype="multipart/form-data" class="mb-3">
          {{ support_form.hidden_tag() }}
          <div class="mb-2">
            {{ support_form.remark(class='form-control', rows='2', placeholder='Add a short remark (optional)') }}
          </div>
          <div class="mb-2">
            {{ support_form.image(class='form-control', accept='image/jpeg,image/png,image/webp', **{'data-max-bytes': current_app.config['MAX_IMAGE_UPLOAD_BYTES'] if current_app else 8000000}) }}
          </div>
          <div class="d-flex align-items-center gap-2">
            {{ support_form.submit(class='btn btn-outline-primary btn-sm btn-hover-lift') }}
            <span class="small text-muted">Supporters: {{ support_count }}</span>
          </div>
        </form>
        <div class="d-flex flex-column gap-3">
          {% for support in complaint.supports %}
          <div class="support-card border rounded p-3">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">{{ support.user.full_name if support.user else 'User' }}</div>
                <div class="small text-muted">{{ support.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
              </div>
            </div>
            {% if support.remark %}<p class="small mb-2">{{ support.remark }}</p>{% endif %}
            {% if support.images %}
            <div class="d-flex flex-wrap gap-2">
              {% for image in support.images %}
              <div class="evidence-thumb text-center">
                <img src="{{ url_for('complaints.view_support_image', image_id=image.id) }}" alt="Support image" class="img-fluid rounded mb-1">
                <div class="badge bg-{{ image.authenticity_flag | auth_badge }} text-white w-100">{{ image.authenticity_flag }}</div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% else %}
          <div class="text-muted small">No supporters yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card glass-card border-0 shadow-sm lift-card mb-3">
      <div class="card-body">
        <div class="section-heading mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-dark text-white"><i class="bi bi-images"></i></span>
            <div>
              <h6 class="mb-0">Evidence</h6>
              <small class="text-muted">Uploaded proof &amp; hashes</small>
            </div>
          </div>
        </div>
        {% for image in complaint.images %}
        <div class="evidence-card border rounded mb-3 p-2">
          <div class="ratio ratio-4x3 rounded overflow-hidden bg-light d-flex align-items-center justify-content-center mb-2">
            <img src="{{ url_for('complaints.view_complaint_image', complaint_id=complaint.id, image_id=image.id) }}" alt="Evidence image" class="img-fluid object-fit-contain">
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="badge bg-{{ image.authenticity_flag | auth_badge }} text-white">{{ image.authenticity_flag }}</span>
          </div>
        </div>
        {% else %}
        <div class="text-muted small">No evidence stored.</div>
        {% endfor %}
      </div>
    </div>
    <div class="card glass-card border-0 shadow-sm lift-card mb-3">
      <div class="card-body">
        <div class="section-heading mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-info text-white"><i class="bi bi-journal-check"></i></span>
            <div>
              <h6 class="mb-0">Official Communication Log</h6>
              <small class="text-muted">Delivery audit trail</small>
            </div>
          </div>
        </div>
        <div class="list-group list-group-flush">
          {% for log in email_logs %}
          <div class="list-group-item px-0">
            <div class="d-flex justify-content-between align-items-start">
              <div class="fw-semibold small">{{ log.subject }}</div>
              <span class="badge bg-{{ 'success' if log.delivery_status == 'SENT' else 'danger' if log.delivery_status == 'FAILED' else 'warning' }} text-white">{{ log.delivery_status }}</span>
            </div>
            <div class="small text-muted">{{ log.sent_at.strftime('%Y-%m-%d %H:%M') if log.sent_at else '' }}</div>
            <div class="small text-muted">To: {{ log.recipient_email | mask_email }}</div>
            {% if log.cc_emails %}<div class="small text-muted">CC: {{ log.cc_emails | join(', ') | mask_email }}</div>{% endif %}
            {% if log.error_message %}<div class="small text-danger">Error: {{ log.error_message }}</div>{% endif %}
          </div>
          {% else %}
          <div class="text-muted small">No emails dispatched yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="card glass-card border-0 shadow-sm lift-card">
      <div class="card-body">
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="icon-circle bg-secondary-subtle text-secondary"><i class="bi bi-shield-lock"></i></span>
          <h6 class="mb-0">Traceability</h6>
        </div>
        <div class="small text-muted">All actions (creation, image uploads, AI analysis, and support) are logged for audit. Status updates are controlled by authorized officers only.</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='js/complaints.js') }}"></script>
{% endblock %}
