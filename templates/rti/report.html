{% extends 'base.html' %}
{% block title %}RTI Report Preview{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pdf.css') }}">
<style>
  .rti-hero {
    background: linear-gradient(120deg, #0b3d91 0%, #1f5fbf 60%, #0f2439 100%);
    color: #fff;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 14px 40px rgba(15, 76, 129, 0.16);
  }

  .rti-hero .pill {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.85rem;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.16);
    border: 1px solid rgba(255, 255, 255, 0.24);
    letter-spacing: 0.02em;
    text-transform: uppercase;
    font-weight: 700;
    font-size: 0.8rem;
  }

  .rti-hero .metric {
    display: inline-flex;
    align-items: center;
    gap: 0.55rem;
    padding: 0.65rem 0.9rem;
    border-radius: 0.85rem;
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(8px);
    min-width: 180px;
  }

  .rti-hero .metric .label {
    font-size: 0.82rem;
    opacity: 0.85;
  }

  .rti-hero .metric .value {
    font-weight: 700;
    font-size: 1rem;
  }

  .card-soft {
    border: 1px solid #e6ecf5;
    background: #f9fbff;
    border-radius: 1rem;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7), 0 8px 28px rgba(11, 76, 140, 0.08);
  }

  .info-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    border: 1px solid #e6ecf5;
    background: #f5f7fb;
    font-weight: 600;
    font-size: 0.85rem;
  }

  .divider-dash {
    border-top: 1px dashed #d8e0ec;
    margin: 1rem 0;
  }

  .timeline-list li {
    padding: 0.6rem 0.75rem;
    border-radius: 0.65rem;
    border: 1px solid #e6ecf5;
    background: #fdfefe;
    box-shadow: 0 6px 16px rgba(11, 76, 140, 0.05);
  }

  .code-badge {
    border-radius: 0.65rem;
    padding: 0.45rem 0.65rem;
    background: #f4f7fb;
    border: 1px dashed #d7dfec;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 0.9rem;
  }

  .lift-card {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .lift-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 14px 30px rgba(15, 76, 129, 0.12);
  }

  .alert-hero {
    border-radius: 0.9rem;
    border: 1px solid rgba(255, 193, 7, 0.35);
    background: linear-gradient(145deg, #fff7e6, #fff3d9);
    box-shadow: 0 10px 26px rgba(255, 193, 7, 0.16);
  }

  .badge-soft-dark {
    background: rgba(33, 37, 41, 0.12);
    color: #0b3d91;
    border: 1px solid rgba(33, 37, 41, 0.2);
  }
</style>

<div class="rti-hero mb-4">
  <div class="p-4 p-lg-5 d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-4">
    <div class="d-flex align-items-start gap-3">
      <div class="icon-circle bg-white text-primary" style="width:52px; height:52px;">
        <i class="bi bi-shield-lock fs-5"></i>
      </div>
      <div>
        <div class="pill mb-2"><i class="bi bi-journal-check"></i> RTI Report</div>
        <h2 class="h4 mb-2">Read-only legal snapshot</h2>
        <p class="mb-3 small">Immutable RTI record with checksum, audit log, and snapshot of linked project or complaint.</p>
        <div class="d-flex flex-wrap gap-2">
          <div class="metric">
            <i class="bi bi-hash"></i>
            <div>
              <div class="label">Reference ID</div>
              <div class="value">{{ record.reference_id }}</div>
            </div>
          </div>
          <div class="metric">
            <i class="bi bi-clock-history"></i>
            <div>
              <div class="label">Generated (UTC)</div>
              <div class="value">{{ record.generated_at.strftime('%Y-%m-%d %H:%M') }}</div>
            </div>
          </div>
          <div class="metric">
            <i class="bi bi-shield-check"></i>
            <div>
              <div class="label">Integrity</div>
              <div class="value">Checksum locked</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-light text-primary btn-hover-lift" href="{{ url_for('transparency.rti_download', reference_id=record.reference_id) }}">
        <i class="bi bi-file-earmark-pdf"></i>
        Download PDF
      </a>
    </div>
  </div>
</div>

<div class="row g-4 rti-preview">
  <div class="col-12">
    <div class="alert alert-warning alert-hero" role="alert">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div class="d-flex align-items-start gap-2">
          <div class="icon-circle bg-white text-warning" style="width:46px; height:46px;">
            <i class="bi bi-exclamation-triangle"></i>
          </div>
          <div>
            <div class="fw-semibold">For RTI / Legal Use</div>
            <div class="small mb-0">This document is system-generated, read-only, and logged. Any modification invalidates the checksum.</div>
          </div>
        </div>
        <a class="btn btn-danger btn-hover-lift" href="{{ url_for('transparency.rti_download', reference_id=record.reference_id) }}">
          <i class="bi bi-download"></i>
          Export signed PDF
        </a>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0 h-100 lift-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="text-uppercase small text-muted">Reference</div>
            <div class="fw-bold d-flex align-items-center gap-1">
              <i class="bi bi-upc-scan text-primary"></i>
              {{ record.reference_id }}
            </div>
          </div>
          <span class="badge badge-soft-dark">{{ record.entity_type }}</span>
        </div>
        <div class="small text-muted">Generated At (UTC)</div>
        <div class="fw-semibold mb-2">{{ record.generated_at.strftime('%Y-%m-%d %H:%M') }}</div>
        <div class="small text-muted">Checksum (sha256)</div>
        <div class="code-badge">{{ record.pdf_checksum }}</div>
        <div class="small text-muted mt-3">Entity ID</div>
        <div class="fw-semibold">{{ record.entity_id }}</div>
        <div class="small text-muted mt-3">Path</div>
        <div class="small">{{ record.pdf_path }}</div>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card shadow-sm border-0 mb-3 lift-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-light text-primary"><i class="bi bi-clipboard-check"></i></span>
            <div>
              <div class="fw-semibold">Generation Log</div>
              <div class="small text-muted">Complete trail of when and how this report was produced.</div>
            </div>
          </div>
          <span class="info-chip"><i class="bi bi-shield-check"></i>Audit ready</span>
        </div>
        <ul class="list-unstyled small mb-0 timeline-list">
          {% for log in record.logs %}
          <li class="mb-2">
            <div class="fw-semibold text-primary">{{ log.triggered_at.strftime('%Y-%m-%d %H:%M') }}</div>
            <div class="text-muted">{{ log.event_type }} {% if log.notes %} ({{ log.notes }}){% endif %}</div>
          </li>
          {% else %}
          <li class="text-muted">No audit log captured.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="card shadow-sm border-0 lift-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-circle bg-light text-primary"><i class="bi bi-shield-check"></i></span>
            <div>
              <div class="fw-semibold">Snapshot</div>
              <div class="small text-muted">Instant view of the linked project or complaint at generation time.</div>
            </div>
          </div>
          <span class="info-chip"><i class="bi bi-lock"></i>Immutable</span>
        </div>
        {% if project %}
        <div class="row g-3">
          <div class="col-md-6">
            <div class="small text-muted">Project</div>
            <div class="fw-semibold d-flex align-items-center gap-2">
              <i class="bi bi-building"></i>
              {{ project.project_name }}
            </div>
            <div class="small text-muted">{{ project.project_type }}</div>
          </div>
          <div class="col-md-3">
            <div class="small text-muted">Status</div>
            <span class="badge bg-secondary">{{ project.current_status }}</span>
          </div>
          <div class="col-md-3">
            <div class="small text-muted">Cost</div>
            <div class="fw-semibold">{{ project.project_cost or 'N/A' }}</div>
          </div>
          <div class="col-md-12">
            <div class="small text-muted">Location</div>
            <div class="fw-semibold d-flex align-items-center gap-2">
              <i class="bi bi-geo-alt"></i>
              {{ project.location_query.location_name if project.location_query else 'N/A' }}
            </div>
          </div>
        </div>
        {% endif %}

        {% if complaint %}
        <div class="divider-dash"></div>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="small text-muted">Complaint</div>
            <div class="fw-semibold d-flex align-items-center gap-2">
              <i class="bi bi-megaphone"></i>
              {{ complaint.title }}
            </div>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">Severity</div>
            <span class="badge bg-{{ complaint.severity_level | severity_badge }} text-white">{{ complaint.severity_level }}</span>
          </div>
          <div class="col-md-4">
            <div class="small text-muted">Status</div>
            <span class="badge bg-{{ complaint.status | status_badge }} text-white">{{ complaint.status }}</span>
          </div>
          <div class="col-12">
            <div class="small text-muted">Summary</div>
            <p class="small mb-0">{{ complaint.description }}</p>
          </div>
        </div>
        {% if ai_markdown_html %}
        <div class="mt-3">
          <div class="small text-muted">AI Findings</div>
          <div class="small markdown-body" style="line-height: 1.6;">
            {{ ai_markdown_html|safe }}
          </div>
        </div>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/button_spinner.js') }}"></script>
{% endblock %}
